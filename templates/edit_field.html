<!--  Добавление участия  -->

{% extends 'base.html' %}

{% block title %}Путь к успеху{% endblock %}

{% block content %}

    <span class="close">&times;</span>
    <h1>Добавить запись об участии в конкурсе</h1>
    <form  id="uploadForm" action="{{ url_for('add_data_entry',  child_id=child['id_table']) }}" method="post" enctype="multipart/form-data">

        <label for="fio">ФИО:</label>
            <input type="hidden" name="field_id" id="field_id" value="{{ child['id_table'] }}" readonly>
            <input type="hidden" type="text" id="fio" name="id_spisok" value="{{ child['id'] }}" readonly>
            <span>{{ child[1] }}</span>
        <br><br>

        <label for="competition">Конкурс:</label>
        <select name="id_events_table" id="competition" required>
            {% for event in events %}
                <option value="{{ event.id }}">{{ event.name }}</option>
            {% endfor %}
        </select>
        <br><br>

        <label for="doc_type">Результат:</label>
<!--        <input type="text" name="result" id="result" >-->
            <select name="doc_type" id="doc_type" >
                {% for doc_t in docs %}
                    <option value="{{ doc_t }}">{{ doc_t }}</option>
                {% endfor %}
            </select>
        <br><br>

        <label for="fileInput">Файл:</label>
        <input type="file" name="fileInput" id="fileInput" accept=".txt,.pdf,.doc,.docx">
        <input type="hidden" name="saved_file_name" id="saved_file_name">
        <div id="progress">
            <div id="progress-bar"></div>
        </div>
        <div id="message"></div>
        <br><br>

        <label for="date_otcheta">Дата включения в отчет:</label>
        <input type="date" id="date_otcheta" name="date_otcheta" ><br>

        <input type="submit" value="Добавить запись">
        <button type="button" class="cancel-button" onclick="history.back();">Отмена</button> <!-- Кнопка Отмена -->
    </form>

    <script>
    $("#fileInput").on("change", function() {
        // Получаем выбранный файл
        var file = this.files[0];
        if (!file) return;

        // Генерация уникального имени файла только после выбора
        var uniqueFileName = 'file_' + Date.now() + '_' + Math.floor(Math.random() * 1000);
        document.getElementById('saved_file_name').value = uniqueFileName;
    });

    // === НОВЫЙ КОД: ОБРАБОТЧИК ФОРМЫ ===
    $("#uploadForm").on("submit", function(e) {
        e.preventDefault(); // ⚠️ ОСТАНОВИЛИ СТАНДАРТНУЮ ОТПРАВКУ

        const docType = $("#doc_type").val();
        const dateOtcheta = $("#date_otcheta").val();

        // Если указан результат — дата обязательна
        if (docType && docType !== ' ') {
            if (!dateOtcheta) {
                alert("Дата отчета обязательна, если указан результат");
                return;
            }
        }

        // Отправляем форму через JS
        this.submit(); // ✔️ Теперь отправляем программно
    });
</script>

{% endblock %}